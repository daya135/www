<!DOCTYPE html>
<html>

    <head>
        <meta charset="UTF-8">
        <title>Tile Test</title>
        <script type="text/javascript" src="../js/ol.js"></script>
        <script src="../js/jquery-1.11.1.min.js"></script>
        <link rel="stylesheet" type="text/css" href="../css/ol.css" />
        <script type="text/javascript">
            //字符截取
            var padLeft_ = function(num, val) {
                return(new Array(num).join('0') + val).slice(-num);
            };
            //xy行列转换
            var convert_ = function(zoomLevel, x, y) {
                var extent = Math.pow(2, zoomLevel);
//              if(x < 0 || x > extent - 1) {
//                  console.log("The X coordinate is not sane: " + x);
//                  return;
//              }
//              if(y < 0 || y > extent - 1) {
//                  console.log("The Y coordinate is not sane: " + y);
//                  return;
//              }
                var gridLoc = [x, extent - y - 1, zoomLevel];
                return gridLoc;
            }

            function InitMap() {
                //let bounds = ol.proj.transform([-757.3566088342263, -16.483801201524212, 598.9795901692924, 1030.1803820942798], 'EPSG:4326', 'EPSG:3857');
                let bounds = [-757.3566088342263, -16.483801201524212, 598.9795901692924, 1030.1803820942798];
                //let bounds = [-74.02722, 40.684221, -73.907005, 40.878178];
                console.log("bounds:", bounds);

                let projection = ol.proj.get('EPSG:3857');
                //              let startResolution = ol.extent.getWidth(bounds) / 256;

                let resolutions = new Array(9);
                let maxZoom = 8;
                //              for(let i = 0; i < resolutions.length; ++i) {
                //                  resolutions[i] = startResolution / Math.pow(2, i);
                //              }
                for(var i = 0; i <= maxZoom; i++) {
                    resolutions[i] = Math.pow(2, maxZoom - i);
                }
                console.log('resolutions', resolutions);

                let TileLayers = new ol.layer.Tile({
                    source: new ol.source.TileImage({
                        tileUrlFunction: function(xyz, obj1, obj2) {
                            if(!xyz)
                                return "";
                            var z = xyz[0];
                            var x = Math.abs(xyz[1]);
                            var y = Math.abs(xyz[2]);
                            console.log('xyz', xyz);
                            console.log('obj1', obj1);
                            console.log('obj2', obj2);
                            var xyz_convert = convert_(z, x, y);
                            x = xyz_convert[0];
                            y = xyz_convert[1];
                            z = xyz_convert[2];
                            var shift = z / 2;
                            var half = 2 << shift;
                            var digits = 1;
                            if(half > 10)
                                digits = parseInt(Math.log(half) / Math.log(10)) + 1;
                            var halfx = parseInt(x / half);
                            var halfy = parseInt(y / half);
                            x = parseInt(x);
                            y = parseInt(y) + 1;
                            var url = "ChangBei/EPSG_4326" + "_" + padLeft_(2, z) + "/" + padLeft_(digits, halfx) + "_" + padLeft_(digits, halfy) + "/" + padLeft_(2 * digits, x) + "_" + padLeft_(2 * digits, y) + ".jpeg";
                            console.log("url", url)
                            return url;
                        }
                    })
                });

                let mousePositionControl = new ol.control.MousePosition({
                    className: 'custom-mouse-position',
                    target: document.getElementById('PosID'),
                    coordinateFormat: ol.coordinate.createStringXY(2),
                    undefinedHTML: '&nbsp;'
                });

                map = new ol.Map({
                    layers: [TileLayers],
                    target: 'map',
                    view: new ol.View({
                        projection: projection,
                        zoom: 1,
                        minZoom: 1,
                        maxZoom: 8,
                        center: [0, 0]
                    })
                });
                //map.fit(bounds, map.getSize())
            }
            //按位补0
            function zeroFill(num, len, radix) {
                var str = num.toString(radix || 10);
                while(str.length < len) {
                    str = "0" + str;
                }
                return str;
            }
        </script>
    </head>

    <body style="height:100%" onload="InitMap();">
        <div id="PosID" style="height:20px;border: 2px solid black;"></div>
        <div id="map" style="width:1000px; height:600px; border: 2px solid black;"></div>
    </body>

</html>